name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 120

    env:
      ANDROID_HOME: /usr/local/android-sdk
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      DEFAULT_KEYSTORE_PASSWORD: Fungen@2025
      DEFAULT_KEY_PASSWORD: Fungen@2025
      DEFAULT_KEY_ALIAS: fungen-key-alias

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Detect package manager
        id: pkg
        run: |
          if [ -f "yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi

      - name: Install JS dependencies
        run: |
          if [ "${{ steps.pkg.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci || npm install
          fi

      - name: Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      - name: Install Android SDK (manual, persistent)
        run: |
          sudo mkdir -p $ANDROID_HOME
          sudo chown $USER:$USER $ANDROID_HOME

          echo "‚¨áÔ∏è Downloading Android command line tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d $ANDROID_HOME/cmdline-tools
          # ensure path is in expected layout
          if [ -d "$ANDROID_HOME/cmdline-tools/cmdline-tools" ]; then
            mv $ANDROID_HOME/cmdline-tools/cmdline-tools $ANDROID_HOME/cmdline-tools/latest
          else
            mkdir -p $ANDROID_HOME/cmdline-tools/latest
            mv $ANDROID_HOME/cmdline-tools/* $ANDROID_HOME/cmdline-tools/latest || true
          fi

          # ensure sdkmanager on PATH for this run
          export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH

          echo "‚úî Accepting licenses..."
          yes | sdkmanager --licenses || true

          echo "‚¨áÔ∏è Installing platform-tools, build-tools and platform"
          yes | sdkmanager "platform-tools" || true
          yes | sdkmanager "build-tools;34.0.0" || true
          yes | sdkmanager "platforms;android-34" || true

      - name: Setup Keystore (decode from secret or generate)
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || env.DEFAULT_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || env.DEFAULT_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || env.DEFAULT_KEY_ALIAS }}
        run: |
          mkdir -p android/app
          if [ -n "$KEYSTORE_B64" ]; then
            echo "‚úì Using provided keystore (decoded)"
            echo "$KEYSTORE_B64" | base64 --decode > android/app/fungen-key.keystore
          else
            echo "‚ö†Ô∏è No keystore secret found ‚Äî generating keystore with defaults"
            keytool -genkeypair \
              -alias "$KEY_ALIAS" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storetype PKCS12 \
              -keystore android/app/fungen-key.keystore \
              -storepass "$KEYSTORE_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              -dname "CN=FunGen, OU=Mobile, O=FunGen Apps, L=Mumbai, ST=Maharashtra, C=IN" \
              -noprompt
            mkdir -p keystore-backup
            cp android/app/fungen-key.keystore keystore-backup/
            echo "‚úî Generated keystore and saved to keystore-backup/"
          fi

      - name: Ensure real gradlew script (replace placeholder if found)
        run: |
          if [ ! -f android/gradlew ] || grep -q "Placeholder gradlew" android/gradlew 2>/dev/null; then
            echo "‚ö†Ô∏è Creating correct android/gradlew (replaces placeholder/absent file)"
            cat > android/gradlew <<'EOF'
#!/usr/bin/env sh
PRG="$0"
while [ -h "$PRG" ] ; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`"/$link"
  fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/.." >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null
CLASSPATH="$APP_HOME/gradle/wrapper/gradle-wrapper.jar"
if [ -n "$JAVA_HOME" ] ; then
  if [ -x "$JAVA_HOME/bin/java" ] ; then
    JAVACMD="$JAVA_HOME/bin/java"
  else
    JAVACMD="$JAVA_HOME/jre/bin/java"
  fi
else
  JAVACMD="java"
fi
exec "$JAVACMD" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
EOF
            chmod +x android/gradlew
          else
            echo "‚úì android/gradlew looks valid"
          fi

      - name: Replace Gradle wrapper JAR with 9.2.1 (robust download + validate)
        run: |
          set -euo pipefail
          mkdir -p android/gradle/wrapper
          echo "üîç listing any existing gradle-wrapper.jar files..."
          find . -name "gradle-wrapper.jar" -print || true

          echo "üóëÔ∏è removing any existing gradle-wrapper.jar"
          find . -name "gradle-wrapper.jar" -delete || true

          echo "‚¨áÔ∏è Downloading Gradle 9.2.1 (CI-safe CDN) with retries..."
          # downloads.gradle-dn.com is CI safe. fall back to services.gradle.org if needed
          URL="https://downloads.gradle-dn.com/distributions/gradle-9.2.1-all.zip"
          curl --retry 5 --retry-delay 5 --location --fail "$URL" -o gradle.zip

          echo "üì¶ Checking downloaded file size (bytes):"
          stat -c%s gradle.zip || true

          # quick sanity: if file is tiny (<1MB) print head to show error HTML
          SIZE=$(stat -c%s gradle.zip || echo 0)
          if [ "$SIZE" -lt 1048576 ]; then
            echo "‚ö†Ô∏è gradle.zip looks unexpectedly small ($SIZE bytes) ‚Äî printing first 200 bytes for debug"
            head -c 200 gradle.zip | sed 's/<[^>]*>//g' || true
            exit 20
          fi

          echo "üì¶ Extracting wrapper jar (actual path for 9.2.1)..."
          unzip -j gradle.zip "gradle-9.2.1/lib/gradle-wrapper-shared-9.2.1.jar" -d android/gradle/wrapper/

          if [ ! -f android/gradle/wrapper/gradle-wrapper-shared-9.2.1.jar ]; then
            echo "‚ùå Expected jar not found in the ZIP ‚Äî listing archive contents for debugging:"
            unzip -l gradle.zip | sed -n '1,200p' || true
            exit 21
          fi

          mv android/gradle/wrapper/gradle-wrapper-shared-9.2.1.jar android/gradle/wrapper/gradle-wrapper.jar
          echo "üîé Final wrapper path:"
          ls -l android/gradle/wrapper/gradle-wrapper.jar || true

      - name: Make gradlew executable
        run: chmod +x android/gradlew

      - name: Verify Gradle and Project (quick)
        working-directory: android
        run: |
          ./gradlew --version || true
          ./gradlew tasks --all | grep -i bundle || true

      - name: Build Android AAB
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || env.DEFAULT_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || env.DEFAULT_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || env.DEFAULT_KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease --stacktrace --no-daemon --info

      - name: Upload AAB Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: FunGen-AAB-${{ github.sha }}
          path: android/app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 30

      - name: Upload Generated Keystore (if any)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: FunGen-Keystore-${{ github.sha }}
          path: keystore-backup/fungen-key.keystore
          if-no-files-found: ignore
          retention-days: 90

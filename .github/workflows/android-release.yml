name: Android Release Build

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'android/**'
      - 'src/**'
      - 'package.json'

jobs:
  build-android:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      ANDROID_SDK_ROOT: /usr/local/android-sdk
      # Defaults (overridable by repository secrets)
      DEFAULT_KEYSTORE_PASSWORD: Fungen@2025
      DEFAULT_KEY_PASSWORD: Fungen@2025
      DEFAULT_KEY_ALIAS: fungen-key-alias

    steps:
      # -------------------------------
      # CHECKOUT
      # -------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------
      # SETUP NODE
      # -------------------------------
      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Detect package manager
        id: pkg
        run: |
          if [ -f "yarn.lock" ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
          fi

      - name: Install JS dependencies
        run: |
          if [ "${{ steps.pkg.outputs.manager }}" = "yarn" ]; then
            yarn install --frozen-lockfile
          else
            npm ci || npm install
          fi

      # -------------------------------
      # SETUP JAVA
      # -------------------------------
      - name: Setup Java 17 (Temurin)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: gradle

      # -------------------------------
      # INSTALL ANDROID SDK (manual & stable)
      # -------------------------------
      - name: Install Android SDK (manual)
        run: |
          sudo mkdir -p $ANDROID_SDK_ROOT
          sudo chown $USER:$USER $ANDROID_SDK_ROOT

          echo "‚¨áÔ∏è Downloading Android command line tools..."
          wget -q https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline.zip
          unzip -q cmdline.zip -d $ANDROID_SDK_ROOT/cmdline-tools
          # move extracted folder to 'latest' path used by sdkmanager
          if [ -d "$ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools" ]; then
            mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest
          else
            mv $ANDROID_SDK_ROOT/cmdline-tools $ANDROID_SDK_ROOT/cmdline-tools/latest || true
          fi

          export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH

          echo "‚úî Accepting licenses..."
          yes | sdkmanager --licenses || true

          echo "‚¨áÔ∏è Installing platform-tools + build-tools + platform"
          yes | sdkmanager "platform-tools" || true
          yes | sdkmanager "build-tools;34.0.0" || true
          yes | sdkmanager "platforms;android-34" || true

      # -------------------------------
      # KEYSTORE (decode from secret or auto-generate)
      # -------------------------------
      - name: Setup Keystore
        env:
          KEYSTORE_B64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || env.DEFAULT_KEYSTORE_PASSWORD }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || env.DEFAULT_KEY_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || env.DEFAULT_KEY_ALIAS }}
        run: |
          mkdir -p android/app
          # If KEYSTORE_B64 supplied, decode it. Otherwise generate.
          if [ -n "$KEYSTORE_B64" ]; then
            echo "‚úì Using provided keystore (decoded from secret)"
            echo "$KEYSTORE_B64" | base64 --decode > android/app/fungen-key.keystore
          else
            echo "‚ö†Ô∏è No keystore secret found ‚Äî generating new keystore with defaults"
            keytool -genkeypair \
              -alias "$KEY_ALIAS" \
              -keyalg RSA \
              -keysize 2048 \
              -validity 10000 \
              -storetype PKCS12 \
              -keystore android/app/fungen-key.keystore \
              -storepass "$KEYSTORE_PASSWORD" \
              -keypass "$KEY_PASSWORD" \
              -dname "CN=FunGen, OU=Mobile, O=FunGen Apps, L=Mumbai, ST=Maharashtra, C=IN" \
              -noprompt
            mkdir -p keystore-backup
            cp android/app/fungen-key.keystore keystore-backup/
            echo "‚úî Generated keystore and saved to keystore-backup/"
          fi

      # -------------------------------
      # ENSURE A VALID gradlew SCRIPT (replace placeholder if necessary)
      # -------------------------------
      - name: Ensure real gradlew script
        run: |
          # If gradlew looks like the placeholder, overwrite with a correct script.
          if grep -q "Placeholder gradlew" android/gradlew 2>/dev/null || [ ! -f android/gradlew ]; then
            echo "‚ö†Ô∏è Replacing placeholder/absent android/gradlew with real wrapper script"
            cat > android/gradlew <<'EOF'
#!/usr/bin/env sh
##############################################################################
# Gradle start up script (POSIX) - generated by CI helper
##############################################################################
PRG="$0"
# Resolve symlinks
while [ -h "$PRG" ] ; do
  ls=`ls -ld "$PRG"`
  link=`expr "$ls" : '.*-> \(.*\)$'`
  if expr "$link" : '/.*' > /dev/null; then
    PRG="$link"
  else
    PRG=`dirname "$PRG"`"/$link"
  fi
done
SAVED="`pwd`"
cd "`dirname \"$PRG\"`/.." >/dev/null
APP_HOME="`pwd -P`"
cd "$SAVED" >/dev/null
CLASSPATH="$APP_HOME/gradle/wrapper/gradle-wrapper.jar"
if [ -n "$JAVA_HOME" ] ; then
  if [ -x "$JAVA_HOME/bin/java" ] ; then
    JAVACMD="$JAVA_HOME/bin/java"
  else
    JAVACMD="$JAVA_HOME/jre/bin/java"
  fi
else
  JAVACMD="java"
fi
exec "$JAVACMD" -classpath "$CLASSPATH" org.gradle.wrapper.GradleWrapperMain "$@"
EOF
            chmod +x android/gradlew
          else
            echo "‚úì android/gradlew looks valid ‚Äî leaving it"
          fi

      # -------------------------------
      # REPLACE CORRUPTED gradle-wrapper.jar WITH GRADLE 9.2.1 (CI-safe mirror)
      # -------------------------------
      - name: Replace Gradle Wrapper JAR (Gradle 9.2.1)
        run: |
          set -e
          mkdir -p android/gradle/wrapper
          echo "üîç Locating any existing gradle-wrapper.jar files..."
          find . -name "gradle-wrapper.jar" -print || true

          echo "üóëÔ∏è Removing existing wrapper jars (if any)..."
          find . -name "gradle-wrapper.jar" -delete || true

          echo "‚¨áÔ∏è Downloading Gradle 9.2.1 (CI-safe mirror)..."
          # Use the downloads.gradle-dn.com CDN to avoid CI-side bot blocking
          curl --fail -L https://downloads.gradle-dn.com/distributions/gradle-9.2.1-all.zip -o gradle.zip

          echo "üì¶ Inspecting archive contents (short list)..."
          unzip -l gradle.zip | sed -n '1,20p' || true

          # correct file inside zip for Gradle 9.2.1: gradle-9.2.1/lib/gradle-wrapper-shared-9.2.1.jar
          echo "üì¶ Extracting gradle-wrapper-shared-9.2.1.jar..."
          unzip -j gradle.zip "gradle-9.2.1/lib/gradle-wrapper-shared-9.2.1.jar" -d android/gradle/wrapper/

          echo "üìÑ Renaming to gradle-wrapper.jar (required name)..."
          if [ -f android/gradle/wrapper/gradle-wrapper-shared-9.2.1.jar ]; then
            mv android/gradle/wrapper/gradle-wrapper-shared-9.2.1.jar android/gradle/wrapper/gradle-wrapper.jar
          fi

          echo "üîé Final wrapper locations:"
          find . -name "gradle-wrapper.jar" -print || true
          echo "‚úî Gradle wrapper (9.2.1) installed."

      # -------------------------------
      # MAKE gradlew EXECUTABLE
      # -------------------------------
      - name: Make gradlew executable
        run: chmod +x android/gradlew

      # -------------------------------
      # BUILD AAB
      # -------------------------------
      - name: Build Android AAB
        working-directory: android
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD || env.DEFAULT_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS || env.DEFAULT_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD || env.DEFAULT_KEY_PASSWORD }}
        run: |
          ./gradlew bundleRelease --stacktrace --no-daemon --info

      # -------------------------------
      # UPLOAD ARTIFACTS
      # -------------------------------
      - name: Upload AAB Artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: FunGen-AAB-${{ github.sha }}
          path: android/app/build/outputs/bundle/release/*.aab
          if-no-files-found: error
          retention-days: 30

      - name: Upload Generated Keystore (if created)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: FunGen-Keystore-${{ github.sha }}
          path: keystore-backup/fungen-key.keystore
          if-no-files-found: ignore
          retention-days: 90
